var serverUrl = 'fmpttp.action?m=frontCharData';
var itemList = null;
var Y_AIXS_ITEM_HEIGHT = 150;
var Y_AIXS_ITEM_HEIGHT_SPLIT = 50;
var X_BUTTON_HEIGHT = 100;

var getJsonCallBack = function(data) {
	var outputArray = new Array();
	for ( var i = 0; i < data.length; i++) {
		if (data[i] == null)
			continue;
		var url = data[i].jsonUrl;
		data[i].url = url;
		$.ajax({
			type : "GET",
			async : false,
			url : url,
			dataType : "json",
			success : function(rel) {
				data[i].data = rel;
				outputArray.push(data[i]);
			}
		});
	}
	itemList = outputArray;
	drawSingleFunction();
}

var drawSingleFunction = function() {
	var dataseries = new Array();
	var char_y_aixs = new Array();
	if (itemList != null) {
		var data = itemList;
		for ( var i = 0; i < data.length; i++) {
			var dataItem = data[i];
			if (dataItem == null)
				continue;
			var item = new Object();
			var yAixs_item = new Object();
			yAixs_item.title = new Object();
			yAixs_item.title.text = dataItem.name;
			yAixs_item.top = (Y_AIXS_ITEM_HEIGHT_SPLIT + Y_AIXS_ITEM_HEIGHT)
					* i;
			yAixs_item.height = Y_AIXS_ITEM_HEIGHT;
			yAixs_item.offset = 0;
			item.yAxis = i;
			item.name = dataItem.name;
			item.data = dataItem.data;
			char_y_aixs[i] = yAixs_item;
			dataseries[i] = item;
		}
		var length = (Y_AIXS_ITEM_HEIGHT_SPLIT + Y_AIXS_ITEM_HEIGHT)
				* char_y_aixs.length + X_BUTTON_HEIGHT;
		drawServiceFunciont(length, char_y_aixs, dataseries);
	}
}

var drawAllFunction = function() {
	var dataseries = new Array();
	if (itemList != null) {
		var data = itemList;
		for ( var i = 0; i < data.length; i++) {
			var dataItem = data[i];
			if (dataItem == null)
				continue;
			var item = new Object();
			item.name = dataItem.name;
			item.data = dataItem.data;
			dataseries[i] = item;
		}

		drawServiceFunciont(500, null, dataseries);
	}
}


var drawServiceFunciont = function(divHeight, char_y_aixs, dataseries) {

	$("#container").css("height", divHeight);
	chart = new Highcharts.StockChart({
		chart : {
			renderTo : 'container'
		},
		credits : {
			enabled : true,
			href : 'http://www.baidu.com',
			position : {
				align : 'right',
				x : -50,
				verticalAlign : 'bottom',
				y : 0
			},
			text : ''
		},
		rangeSelector : {
			selected : 12
		},

		yAxis : char_y_aixs,
		title : {
			text : ''
		},
		subtitle : {
			text : ''
		},
		legend : {
			layout : 'vertical',
			align : 'right',
			verticalAlign : 'top',
			x : -10,
			y : 100,
			borderWidth : 0
		},
		series : dataseries,
		rangeSelector : {
			enabled : false
		},
	});

}




var getJsonDataUpload = function() {

	var parmps = getParmps();
	$.ajax({
		type : "POST",
		data : parmps,
		// url : 'http://www.baidu.com/CharDataServlet',
		url : serverUrl,
		dataType : "json",
		success : function(data) {
			getJsonCallBack(data);
		}
	});
}

var getParmps = function() {
	var parmps = new Object();
	parmps.key = $("#searckKey").val();
	var data = itemList;
	var itemsStr = '[';
	var writeFlag = false;
	for ( var i = 0; data != null && i < data.length; i++) {
		var item = data[i];
		// {"jsonUrl":"data/1uSEkaYD7sXTlSYTUzfP.json","name":"beeagle"}
		if (item != null) {
			if (writeFlag)
				itemsStr = itemsStr + ",";
			var str = "{'jsonUrl':'" + item.jsonUrl + "','name':'" + item.name
					+ "'}";
			itemsStr = itemsStr + str;
			writeFlag = true;
		}

	}
	itemsStr = itemsStr + ']';
	parmps.items = itemsStr;
	return parmps;
};

$(function() {
	$("#searchButton").click(function() {
	getJsonData();
	});
	$("#searckKey").click(function() {
		$("#searckKey").attr("value", '');
	});
	$("#a_parser_all").click(function() {
		drawAllFunction();
	});
	$("#a_parser_each").click(function() {
		drawSingleFunction();
	});
	$("#date_delete").click(function() {
		window.location.reload(); 
	});
	$('#file_upload').uploadify({
		'buttonText' : '上传文件',
		'swf' : './resources/component/uploadify/uploadify.swf',
		'uploader' : 'fmpttp.action?m=frontUpdateFile',
		'onUploadSuccess' : function(file, data, response) {
			var array = eval("(" + data + ")");
			if (itemList == null)
				itemList = new Array();
			itemList = itemList.concat(array);
			getJsonDataUpload();
		}
	});
});
 var getJsonData = function(id) {
	var parmps = getParmps();
	$.ajax({
		type : "POST",
		data : parmps,
		// url : 'http://www.baidu.com/CharDataServlet',
		url : 'fmpttp.action?m=frontCharData&id='+id,
		dataType : "json",
		success : function(data) {
			getJsonCallBack(data);
		}
	});
}